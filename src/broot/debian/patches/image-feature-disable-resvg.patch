From: NoisyCoil <noisycoil@tutanota.com>
Date: Sun, 22 Sep 2024 01:43:13 +0200
Subject: Gate image functionality behind feature, decouple resvg

This patch lets us build broot without librust-resvg-dev while we wait
for a more recent version to land in Debian. The functionality it
disables - namely, rendering images on the terminal - is likely valued
by broot users (especially those who use the kitty terminal), so we
must remove this patch ASAP.
---
 Cargo.toml                   |  6 ++++--
 src/app/app.rs               |  5 ++++-
 src/app/app_context.rs       |  6 +++++-
 src/app/panel_state.rs       |  1 +
 src/conf/conf.rs             |  6 +++++-
 src/errors.rs                |  7 +++++++
 src/lib.rs                   |  2 ++
 src/preview/mod.rs           |  1 +
 src/preview/preview.rs       | 28 +++++++++++++++++++++++-----
 src/preview/preview_state.rs |  1 +
 10 files changed, 53 insertions(+), 10 deletions(-)

--- a/Cargo.toml
+++ b/Cargo.toml
@@ -151,8 +151,9 @@
 [dependencies.rayon]
 version = "1.8"
 
-[dependencies.resvg]
-version = "0.42"
+#[dependencies.resvg]
+#version = "0.42"
+#optional = true
 
 [dependencies.rustc-hash]
 version = "1"
@@ -229,6 +230,7 @@
 [features]
 clipboard = ["terminal-clipboard"]
 default = ["clipboard", "trash"]
+#image = ["dep:resvg"]
 kitty-csi-check = ["xterm-query"]
 trash = ["dep:trash"]
 
--- a/src/app/app.rs
+++ b/src/app/app.rs
@@ -12,7 +12,6 @@
         errors::ProgramError,
         file_sum,
         git,
-        kitty,
         launchable::Launchable,
         path::closest_dir,
         pattern::InputPattern,
@@ -53,6 +52,9 @@
     },
 };
 
+#[cfg(feature = "image")]
+use crate::kitty;
+
 /// The GUI
 pub struct App {
     /// dimensions of the screen
@@ -281,6 +283,7 @@
             queue!(w, MoveTo(left, top))?;
         }
 
+        #[cfg(feature = "image")]
         kitty::manager()
             .lock()
             .unwrap()
--- a/src/app/app_context.rs
+++ b/src/app/app_context.rs
@@ -9,7 +9,6 @@
         errors::*,
         file_sum,
         icon::*,
-        kitty::TransmissionMedium,
         pattern::SearchModeMap,
         path::SpecialPaths,
         preview::PreviewTransformers,
@@ -27,6 +26,9 @@
     },
 };
 
+#[cfg(feature = "image")]
+use crate::kitty::TransmissionMedium;
+
 /// The container that can be passed around to provide the configuration things
 /// for the whole life of the App
 pub struct AppContext {
@@ -126,6 +128,7 @@
     /// This is determined by app::run on launching the event source.
     pub keyboard_enhanced: bool,
 
+    #[cfg(feature = "image")]
     pub kitty_graphics_transmission: TransmissionMedium,
 
     pub kept_kitty_temp_files: NonZeroUsize,
@@ -246,6 +249,7 @@
             reset_terminal_title_on_exit,
             update_work_dir: config.update_work_dir.unwrap_or(true),
             keyboard_enhanced: false,
+            #[cfg(feature = "image")]
             kitty_graphics_transmission: config.kitty_graphics_transmission
                 .unwrap_or_default(),
             kept_kitty_temp_files,
--- a/src/app/panel_state.rs
+++ b/src/app/panel_state.rs
@@ -262,6 +262,7 @@
                 }
             }
             Internal::open_preview => self.open_preview(None, false, cc),
+            #[cfg(feature = "image")]
             Internal::preview_image => self.open_preview(Some(PreviewMode::Image), false, cc),
             Internal::preview_text => self.open_preview(Some(PreviewMode::Text), false, cc),
             Internal::preview_binary => self.open_preview(Some(PreviewMode::Hex), false, cc),
--- a/src/conf/conf.rs
+++ b/src/conf/conf.rs
@@ -7,7 +7,6 @@
         app::Mode,
         display::{ColsConf, LayoutInstructions},
         errors::{ConfError, ProgramError},
-        kitty::TransmissionMedium,
         path::{
             path_from,
             PathAnchor,
@@ -27,6 +26,9 @@
     },
 };
 
+#[cfg(feature = "image")]
+use crate::kitty::TransmissionMedium;
+
 macro_rules! overwrite {
     ($dst: ident, $prop: ident, $src: ident) => {
         if $src.$prop.is_some() {
@@ -95,6 +97,7 @@
     #[serde(alias="initial-mode")]
     pub initial_mode: Option<Mode>,
 
+    #[cfg(feature = "image")]
     #[serde(alias="kitty-graphics-transmission")]
     pub kitty_graphics_transmission: Option<TransmissionMedium>,
 
@@ -242,6 +245,7 @@
         overwrite!(self, reset_terminal_title_on_exit, conf);
         overwrite!(self, update_work_dir, conf);
         overwrite!(self, enable_kitty_keyboard, conf);
+        #[cfg(feature = "image")]
         overwrite!(self, kitty_graphics_transmission, conf);
         overwrite!(self, kept_kitty_temp_files, conf);
         overwrite!(self, lines_after_match_in_preview, conf);
--- a/src/errors.rs
+++ b/src/errors.rs
@@ -124,12 +124,19 @@
     InvalidMessage                       = "invalid message received",
 }
 
+#[cfg(feature = "image")]
 custom_error! {pub SvgError
     Io {source: io::Error} = "IO Error : {source}",
     Internal { message: &'static str } = "Internal error : {message}",
     Svg {source: resvg::usvg::Error} = "SVG Error: {source}",
 }
 
+#[cfg(not(feature = "image"))]
+custom_error! {pub SvgError
+    Io {source: io::Error} = "IO Error : {source}",
+    Internal { message: &'static str } = "Internal error : {message}",
+}
+
 custom_error! {pub PreviewTransformerError
     InvalidInput = "Invalid input",
     NoOutput = "No output",
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -15,8 +15,10 @@
 pub mod hex;
 pub mod help;
 pub mod icon;
+#[cfg(feature = "image")]
 pub mod image;
 pub mod keys;
+#[cfg(feature = "image")]
 pub mod kitty;
 pub mod launchable;
 pub mod path;
--- a/src/preview/mod.rs
+++ b/src/preview/mod.rs
@@ -16,6 +16,7 @@
 #[serde(rename_all = "snake_case")]
 pub enum PreviewMode {
 
+    #[cfg(feature = "image")]
     /// image
     Image,
 
--- a/src/preview/preview.rs
+++ b/src/preview/preview.rs
@@ -6,7 +6,6 @@
         display::*,
         errors::ProgramError,
         hex::HexView,
-        image::ImageView,
         pattern::InputPattern,
         skin::PanelSkin,
         syntactic::SyntacticView,
@@ -20,8 +19,12 @@
     termimad::{Area, CropWriter, SPACE_FILLING},
 };
 
+#[cfg(feature = "image")]
+use crate::image::ImageView;
+
 pub enum Preview {
     Dir(DirView),
+    #[cfg(feature = "image")]
     Image(ImageView),
     Syntactic(SyntacticView),
     Hex(HexView),
@@ -40,13 +43,19 @@
         if path.is_file() {
             match preferred_mode {
                 Some(PreviewMode::Hex) => Self::hex(path),
+                #[cfg(feature = "image")]
                 Some(PreviewMode::Image) => Self::image(path),
                 Some(PreviewMode::Text) => Self::unfiltered_text(path, con),
                 None => {
-                    // automatic behavior: image, text, hex
-                    ImageView::new(path)
-                        .map(Self::Image)
-                        .unwrap_or_else(|_| Self::unfiltered_text(path, con))
+                    #[cfg(feature = "image")]
+                    {
+                        // automatic behavior: image, text, hex
+                        ImageView::new(path)
+                            .map(Self::Image)
+                            .unwrap_or_else(|_| Self::unfiltered_text(path, con))
+                    }
+                    #[cfg(not(feature = "image"))]
+                    Self::unfiltered_text(path, con)
                 }
             }
         } else {
@@ -65,6 +74,7 @@
                 PreviewMode::Hex => {
                     Ok(HexView::new(path.to_path_buf()).map(Self::Hex)?)
                 }
+                #[cfg(feature = "image")]
                 PreviewMode::Image => {
                     ImageView::new(path).map(Self::Image)
                 }
@@ -93,10 +103,15 @@
     /// build an image view, unless the file can't be interpreted
     /// as an image, in which case a hex view is used
     pub fn image(path: &Path) -> Self {
+        #[cfg(feature = "image")]
+        {
         ImageView::new(path)
             .ok()
             .map(Self::Image)
             .unwrap_or_else(|| Self::hex(path))
+        }
+        #[cfg(not(feature = "image"))]
+        Self::hex(path)
 
     }
     /// build a text preview (maybe with syntaxic coloring) if possible,
@@ -185,6 +200,7 @@
     /// return the preview_mode, or None if we're on IOError or Directory
     pub fn get_mode(&self) -> Option<PreviewMode> {
         match self {
+            #[cfg(feature = "image")]
             Self::Image(_) => Some(PreviewMode::Image),
             Self::Syntactic(_) => Some(PreviewMode::Text),
             Self::ZeroLen(_) => Some(PreviewMode::Text),
@@ -298,6 +314,7 @@
         let con = &disc.con;
         match self {
             Self::Dir(dv) => dv.display(w, disc, area),
+            #[cfg(feature = "image")]
             Self::Image(iv) => iv.display(w, disc, area),
             Self::Syntactic(sv) => sv.display(w, screen, panel_skin, area, con),
             Self::ZeroLen(zlv) => zlv.display(w, screen, panel_skin, area),
@@ -333,6 +350,7 @@
     ) -> Result<(), ProgramError> {
         match self {
             Self::Dir(dv) => dv.display_info(w, screen, panel_skin, area),
+            #[cfg(feature = "image")]
             Self::Image(iv) => iv.display_info(w, screen, panel_skin, area),
             Self::Syntactic(sv) => sv.display_info(w, screen, panel_skin, area),
             Self::Hex(hv) => hv.display_info(w, screen, panel_skin, area),
--- a/src/preview/preview_state.rs
+++ b/src/preview/preview_state.rs
@@ -419,6 +419,7 @@
                 self.mut_preview().next_match();
                 Ok(CmdResult::Keep)
             }
+            #[cfg(feature = "image")]
             Internal::preview_image => self.set_mode(PreviewMode::Image, con),
             Internal::preview_text => self.set_mode(PreviewMode::Text, con),
             Internal::preview_binary => self.set_mode(PreviewMode::Hex, con),
--- a/src/cli/mod.rs
+++ b/src/cli/mod.rs
@@ -172,6 +172,7 @@
 
 fn clear_resources() {
     info!("clearing resources");
+    #[cfg(feature = "image")]
     crate::kitty::manager().lock().unwrap().delete_temp_files();
 }
 
