From 15029290c85f7525479cd9c222aa54f3aafa811e Mon Sep 17 00:00:00 2001
From: NoisyCoil <noisycoil@tutanota.com>
Date: Sun, 2 Feb 2025 16:06:16 +0100
Subject: [PATCH] Update zbus and zvariant to v5

---
 src/dbus/api/collection.rs | 14 +++++++-------
 src/dbus/api/item.rs       | 12 ++++++------
 src/dbus/api/mod.rs        |  4 ++--
 src/dbus/api/prompt.rs     | 12 ++++++------
 src/dbus/api/properties.rs |  4 ++--
 src/dbus/api/secret.rs     |  2 +-
 src/dbus/api/service.rs    | 14 +++++++-------
 src/dbus/api/session.rs    | 12 ++++++------
 src/key.rs                 |  2 +-
 src/portal/secret.rs       | 14 +++++++-------
 10 files changed, 45 insertions(+), 45 deletions(-)

--- a/src/dbus/api/collection.rs
+++ b/src/dbus/api/collection.rs
@@ -3,8 +3,8 @@
 use futures_util::{Stream, StreamExt};
 use serde::Serialize;
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{ObjectPath, OwnedObjectPath, Type},
-    ProxyDefault,
 };
 
 use super::{Item, Prompt, Properties, Secret, Unlockable, DESTINATION};
@@ -18,10 +18,10 @@
 #[doc(alias = "org.freedesktop.Secret.Collection")]
 pub struct Collection<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for Collection<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.Secret.Collection");
-    const DESTINATION: Option<&'static str> = Some(DESTINATION);
-    const PATH: Option<&'static str> = None;
+impl<'a> zbus::proxy::Defaults for Collection<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.Secret.Collection"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(DESTINATION);
+    const PATH: &'static Option<ObjectPath<'static>> = &None;
 }
 
 impl<'a> From<zbus::Proxy<'a>> for Collection<'a> {
@@ -39,9 +39,9 @@
         P: TryInto<ObjectPath<'a>>,
         P::Error: Into<zbus::Error>,
     {
-        zbus::ProxyBuilder::new(connection)
+        zbus::proxy::Builder::new(connection)
             .path(object_path)?
-            .cache_properties(zbus::CacheProperties::No)
+            .cache_properties(zbus::proxy::CacheProperties::No)
             .build()
             .await
             .map_err(From::from)
--- a/src/dbus/api/item.rs
+++ b/src/dbus/api/item.rs
@@ -2,8 +2,8 @@
 
 use serde::Serialize;
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{ObjectPath, OwnedObjectPath, Type},
-    ProxyDefault,
 };
 
 use super::{secret::SecretInner, Prompt, Secret, Session, Unlockable, DESTINATION};
@@ -17,10 +17,10 @@
 #[doc(alias = "org.freedesktop.Secret.Item")]
 pub struct Item<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for Item<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.Secret.Item");
-    const DESTINATION: Option<&'static str> = Some(DESTINATION);
-    const PATH: Option<&'static str> = None;
+impl<'a> zbus::proxy::Defaults for Item<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.Secret.Item"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(DESTINATION);
+    const PATH: &'static Option<ObjectPath<'static>> = &None;
 }
 
 impl<'a> From<zbus::Proxy<'a>> for Item<'a> {
@@ -35,7 +35,7 @@
         P: TryInto<ObjectPath<'a>>,
         P::Error: Into<zbus::Error>,
     {
-        zbus::ProxyBuilder::new(connection)
+        zbus::proxy::Builder::new(connection)
             .path(object_path)?
             .build()
             .await
--- a/src/dbus/api/mod.rs
+++ b/src/dbus/api/mod.rs
@@ -1,5 +1,5 @@
-pub(crate) const DESTINATION: &str = "org.freedesktop.secrets";
-pub(crate) const PATH: &str = "/org/freedesktop/secrets";
+pub(crate) const DESTINATION: zbus::names::BusName<'static> = zbus::names::BusName::WellKnown(zbus::names::WellKnownName::from_static_str_unchecked("org.freedesktop.secrets"));
+pub(crate) const PATH: zbus::zvariant::ObjectPath<'static> = zbus::zvariant::ObjectPath::from_static_str_unchecked("/org/freedesktop/secrets");
 
 /// A common trait implemented by objects that can be
 /// locked or unlocked. Like [`Collection`] or [`Item`].
--- a/src/dbus/api/prompt.rs
+++ b/src/dbus/api/prompt.rs
@@ -3,8 +3,8 @@
 use futures_util::StreamExt;
 use serde::Serialize;
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{ObjectPath, OwnedValue, Type},
-    ProxyDefault,
 };
 
 use super::DESTINATION;
@@ -15,10 +15,10 @@
 #[doc(alias = "org.freedesktop.Secret.Prompt")]
 pub struct Prompt<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for Prompt<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.Secret.Prompt");
-    const DESTINATION: Option<&'static str> = Some(DESTINATION);
-    const PATH: Option<&'static str> = None;
+impl<'a> zbus::proxy::Defaults for Prompt<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.Secret.Prompt"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(DESTINATION);
+    const PATH: &'static Option<ObjectPath<'static>> = &None;
 }
 
 impl<'a> From<zbus::Proxy<'a>> for Prompt<'a> {
@@ -39,7 +39,7 @@
         let path = object_path.try_into().map_err(Into::into)?;
         if path != ObjectPath::default() {
             Ok(Some(
-                zbus::ProxyBuilder::new(connection)
+                zbus::proxy::Builder::new(connection)
                     .path(path)?
                     .build()
                     .await?,
--- a/src/dbus/api/properties.rs
+++ b/src/dbus/api/properties.rs
@@ -62,7 +62,7 @@
         } else {
             let mut map = serializer.serialize_map(Some(2))?;
             map.serialize_entry(ITEM_PROPERTY_LABEL, &Value::from(&self.label))?;
-            let mut dict = zbus::zvariant::Dict::new(String::signature(), String::signature());
+            let mut dict = zbus::zvariant::Dict::new(String::SIGNATURE, String::SIGNATURE);
 
             if let Some(attributes) = &self.attributes {
                 for (key, value) in attributes {
@@ -143,6 +143,6 @@
 
     #[test]
     fn signature() {
-        assert_eq!(Properties::signature(), "a{sv}");
+        assert_eq!(Properties::SIGNATURE, "a{sv}");
     }
 }
--- a/src/dbus/api/secret.rs
+++ b/src/dbus/api/secret.rs
@@ -106,6 +106,6 @@
 
     #[test]
     fn signature() {
-        assert_eq!(Secret::signature(), "(oayays)");
+        assert_eq!(Secret::SIGNATURE, "(oayays)");
     }
 }
--- a/src/dbus/api/service.rs
+++ b/src/dbus/api/service.rs
@@ -2,8 +2,8 @@
 
 use futures_util::{Stream, StreamExt};
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{ObjectPath, OwnedObjectPath, OwnedValue, Type, Value},
-    ProxyDefault,
 };
 
 use super::{
@@ -20,10 +20,10 @@
 #[doc(alias = "org.freedesktop.secrets")]
 pub struct Service<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for Service<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.Secret.Service");
-    const DESTINATION: Option<&'static str> = Some(DESTINATION);
-    const PATH: Option<&'static str> = Some(PATH);
+impl<'a> zbus::proxy::Defaults for Service<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.Secret.Service"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(DESTINATION);
+    const PATH: &'static Option<ObjectPath<'static>> = &Some(PATH);
 }
 
 impl<'a> From<zbus::Proxy<'a>> for Service<'a> {
@@ -34,8 +34,8 @@
 
 impl<'a> Service<'a> {
     pub async fn new(connection: &zbus::Connection) -> Result<Service<'a>, Error> {
-        zbus::ProxyBuilder::new(connection)
-            .cache_properties(zbus::CacheProperties::No)
+        zbus::proxy::Builder::new(connection)
+            .cache_properties(zbus::proxy::CacheProperties::No)
             .build()
             .await
             .map_err(From::from)
--- a/src/dbus/api/session.rs
+++ b/src/dbus/api/session.rs
@@ -2,8 +2,8 @@
 
 use serde::Serialize;
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{ObjectPath, Type},
-    ProxyDefault,
 };
 
 use super::DESTINATION;
@@ -14,10 +14,10 @@
 #[doc(alias = "org.freedesktop.Secret.Session")]
 pub struct Session<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for Session<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.Secret.Session");
-    const DESTINATION: Option<&'static str> = Some(DESTINATION);
-    const PATH: Option<&'static str> = None;
+impl<'a> zbus::proxy::Defaults for Session<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.Secret.Session"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(DESTINATION);
+    const PATH: &'static Option<ObjectPath<'static>> = &None;
 }
 
 impl<'a> From<zbus::Proxy<'a>> for Session<'a> {
@@ -32,7 +32,7 @@
         P: TryInto<ObjectPath<'a>>,
         P::Error: Into<zbus::Error>,
     {
-        zbus::ProxyBuilder::new(connection)
+        zbus::proxy::Builder::new(connection)
             .path(object_path)?
             .build()
             .await
--- a/src/key.rs
+++ b/src/key.rs
@@ -54,7 +54,7 @@
 
 impl From<&Key> for zvariant::Value<'_> {
     fn from(key: &Key) -> Self {
-        let mut array = zvariant::Array::new(u8::signature());
+        let mut array = zvariant::Array::new(u8::SIGNATURE);
         for byte in key.as_ref() {
             array
                 .append(zvariant::Value::U8(*byte))
--- a/src/portal/secret.rs
+++ b/src/portal/secret.rs
@@ -12,8 +12,8 @@
 #[cfg(feature = "tokio")]
 use tokio::{io::AsyncReadExt, net::UnixStream};
 use zbus::{
+    names::{BusName, InterfaceName},
     zvariant::{Fd, ObjectPath, OwnedValue, SerializeDict, Type},
-    ProxyDefault,
 };
 use zeroize::{Zeroize, ZeroizeOnDrop};
 
@@ -68,10 +68,10 @@
 #[derive(Debug)]
 pub struct SecretProxy<'a>(zbus::Proxy<'a>);
 
-impl<'a> ProxyDefault for SecretProxy<'a> {
-    const INTERFACE: Option<&'static str> = Some("org.freedesktop.portal.Secret");
-    const DESTINATION: Option<&'static str> = Some("org.freedesktop.portal.Desktop");
-    const PATH: Option<&'static str> = Some("/org/freedesktop/portal/desktop");
+impl<'a> zbus::proxy::Defaults for SecretProxy<'a> {
+    const INTERFACE: &'static Option<InterfaceName<'static>> = &Some(InterfaceName::from_static_str_unchecked("org.freedesktop.portal.Secret"));
+    const DESTINATION: &'static Option<BusName<'static>> = &Some(BusName::WellKnown(zbus::names::WellKnownName::from_static_str_unchecked("org.freedesktop.portal.Desktop")));
+    const PATH: &'static Option<ObjectPath<'static>> = &Some(ObjectPath::from_static_str_unchecked("/org/freedesktop/portal/desktop"));
 }
 
 impl<'a> From<zbus::Proxy<'a>> for SecretProxy<'a> {
@@ -83,7 +83,7 @@
 impl<'a> SecretProxy<'a> {
     /// Create a new instance of [`SecretProxy`].
     pub async fn new(connection: &zbus::Connection) -> Result<SecretProxy<'a>, zbus::Error> {
-        zbus::ProxyBuilder::new(connection)
+        zbus::proxy::Builder::new(connection)
             .build()
             .await
             .map_err(From::from)
@@ -112,7 +112,7 @@
             "Creating a '{}' proxy and listening for a response",
             path.as_str()
         );
-        let request_proxy: zbus::Proxy = zbus::ProxyBuilder::new(cnx)
+        let request_proxy: zbus::Proxy = zbus::proxy::Builder::new(cnx)
             .interface("org.freedesktop.portal.Request")?
             .destination("org.freedesktop.portal.Desktop")?
             .path(path)?
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -134,6 +134,7 @@
 [dependencies.rand]
 version = "0.8"
 default-features = false
+features = ["std", "std_rng"]
 
 [dependencies.serde]
 version = "1.0"
@@ -162,7 +163,12 @@
 optional = true
 
 [dependencies.zbus]
-version = "4.0"
+version = "5"
+default-features = false
+
+[dependencies.zbus_macros]
+version = "5"
+features = ["gvariant"]
 default-features = false
 
 [dependencies.zeroize]
@@ -170,7 +176,7 @@
 features = ["zeroize_derive"]
 
 [dependencies.zvariant]
-version = "4.0"
+version = "5"
 features = ["gvariant"]
 default-features = false
 
