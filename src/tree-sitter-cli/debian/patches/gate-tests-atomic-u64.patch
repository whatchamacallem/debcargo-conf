--- rust-tree-sitter-cli-0.20.7.orig/src/tests/corpus_test.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/corpus_test.rs
@@ -18,76 +18,89 @@ use tree_sitter::{LogType, Node, Parser,
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_bash_corpus() {
     test_language_corpus("bash");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_c_corpus() {
     test_language_corpus("c");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_cpp_corpus() {
     test_language_corpus("cpp");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_embedded_template_corpus() {
     test_language_corpus("embedded-template");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_go_corpus() {
     test_language_corpus("go");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_html_corpus() {
     test_language_corpus("html");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_javascript_corpus() {
     test_language_corpus("javascript");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_json_corpus() {
     test_language_corpus("json");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_php_corpus() {
     test_language_corpus("php");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_python_corpus() {
     test_language_corpus("python");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_ruby_corpus() {
     test_language_corpus("ruby");
 }
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_rust_corpus() {
     test_language_corpus("rust");
 }
 
+#[cfg(target_has_atomic = "64")]
 fn test_language_corpus(language_name: &str) {
     let grammars_dir = fixtures_dir().join("grammars");
     let error_corpus_dir = fixtures_dir().join("error_corpus");
@@ -233,6 +246,7 @@ fn test_language_corpus(language_name: &
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_feature_corpus_files() {
     let test_grammars_dir = fixtures_dir().join("test_grammars");
 
--- rust-tree-sitter-cli-0.20.7.orig/src/tests/helpers/allocations.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/helpers/allocations.rs
@@ -2,12 +2,15 @@ use std::{
     collections::HashMap,
     os::raw::c_void,
     sync::{
-        atomic::{AtomicBool, AtomicU64, Ordering::SeqCst},
+        atomic::{AtomicBool, Ordering::SeqCst},
         Mutex,
     },
 };
+#[cfg(target_has_atomic = "64")]
+use std::sync::atomic::AtomicU64;
 
 #[ctor::ctor]
+#[cfg(target_has_atomic = "64")]
 unsafe fn initialize_allocation_recording() {
     tree_sitter::set_allocator(
         Some(ts_record_malloc),
@@ -22,6 +25,7 @@ struct Allocation(*const c_void);
 unsafe impl Send for Allocation {}
 unsafe impl Sync for Allocation {}
 
+#[cfg(target_has_atomic = "64")]
 #[derive(Default)]
 struct AllocationRecorder {
     enabled: AtomicBool,
@@ -29,6 +33,7 @@ struct AllocationRecorder {
     outstanding_allocations: Mutex<HashMap<Allocation, u64>>,
 }
 
+#[cfg(target_has_atomic = "64")]
 thread_local! {
     static RECORDER: AllocationRecorder = Default::default();
 }
@@ -40,6 +45,7 @@ extern "C" {
     fn free(ptr: *mut c_void);
 }
 
+#[cfg(target_has_atomic = "64")]
 pub fn record<T>(f: impl FnOnce() -> T) -> T {
     RECORDER.with(|recorder| {
         recorder.enabled.store(true, SeqCst);
@@ -69,6 +75,7 @@ pub fn record<T>(f: impl FnOnce() -> T)
     value
 }
 
+#[cfg(target_has_atomic = "64")]
 fn record_alloc(ptr: *mut c_void) {
     RECORDER.with(|recorder| {
         if recorder.enabled.load(SeqCst) {
@@ -82,6 +89,7 @@ fn record_alloc(ptr: *mut c_void) {
     });
 }
 
+#[cfg(target_has_atomic = "64")]
 fn record_dealloc(ptr: *mut c_void) {
     RECORDER.with(|recorder| {
         if recorder.enabled.load(SeqCst) {
@@ -94,18 +102,21 @@ fn record_dealloc(ptr: *mut c_void) {
     });
 }
 
+#[cfg(target_has_atomic = "64")]
 unsafe extern "C" fn ts_record_malloc(size: usize) -> *mut c_void {
     let result = malloc(size);
     record_alloc(result);
     result
 }
 
+#[cfg(target_has_atomic = "64")]
 unsafe extern "C" fn ts_record_calloc(count: usize, size: usize) -> *mut c_void {
     let result = calloc(count, size);
     record_alloc(result);
     result
 }
 
+#[cfg(target_has_atomic = "64")]
 unsafe extern "C" fn ts_record_realloc(ptr: *mut c_void, size: usize) -> *mut c_void {
     record_dealloc(ptr);
     let result = realloc(ptr, size);
@@ -113,6 +124,7 @@ unsafe extern "C" fn ts_record_realloc(p
     result
 }
 
+#[cfg(target_has_atomic = "64")]
 unsafe extern "C" fn ts_record_free(ptr: *mut c_void) {
     record_dealloc(ptr);
     free(ptr);
--- rust-tree-sitter-cli-0.20.7.orig/src/tests/parser_test.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/parser_test.rs
@@ -770,6 +770,7 @@ fn test_parsing_with_a_timeout_and_a_res
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_parsing_with_a_timeout_and_implicit_reset() {
     allocations::record(|| {
         let mut parser = Parser::new();
@@ -804,6 +805,7 @@ fn test_parsing_with_a_timeout_and_impli
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_parsing_with_timeout_and_no_completion() {
     allocations::record(|| {
         let mut parser = Parser::new();
--- rust-tree-sitter-cli-0.20.7.orig/src/tests/pathological_test.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/pathological_test.rs
@@ -3,6 +3,7 @@ use tree_sitter::Parser;
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_pathological_example_1() {
     let language = "cpp";
     let source = r#"*ss<s"ss<sqXqss<s._<s<sq<(qqX<sqss<s.ss<sqsssq<(qss<qssqXqss<s._<s<sq<(qqX<sqss<s.ss<sqsssq<(qss<sqss<sqss<s._<s<sq>(qqX<sqss<s.ss<sqsssq<(qss<sq&=ss<s<sqss<s._<s<sq<(qqX<sqss<s.ss<sqs"#;
--- rust-tree-sitter-cli-0.20.7.orig/src/tests/query_test.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/query_test.rs
@@ -17,6 +17,7 @@ lazy_static! {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_errors_on_invalid_syntax() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -189,6 +190,7 @@ fn test_query_errors_on_invalid_syntax()
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_errors_on_invalid_symbols() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -268,6 +270,7 @@ fn test_query_errors_on_invalid_symbols(
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_errors_on_invalid_predicates() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -312,6 +315,7 @@ fn test_query_errors_on_invalid_predicat
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_errors_on_impossible_patterns() {
     let js_lang = get_language("javascript");
     let rb_lang = get_language("ruby");
@@ -457,6 +461,7 @@ fn test_query_errors_on_impossible_patte
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_verifies_possible_patterns_with_aliased_parent_nodes() {
     allocations::record(|| {
         let ruby = get_language("ruby");
@@ -482,6 +487,7 @@ fn test_query_verifies_possible_patterns
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_simple_pattern() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -505,6 +511,7 @@ fn test_query_matches_with_simple_patter
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_multiple_on_same_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -552,6 +559,7 @@ fn test_query_matches_with_multiple_on_s
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_multiple_patterns_different_roots() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -583,6 +591,7 @@ fn test_query_matches_with_multiple_patt
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_multiple_patterns_same_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -619,6 +628,7 @@ fn test_query_matches_with_multiple_patt
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_nesting_and_no_fields() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -656,6 +666,7 @@ fn test_query_matches_with_nesting_and_n
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_many_results() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -672,6 +683,7 @@ fn test_query_matches_with_many_results(
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_many_overlapping_results() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -720,6 +732,7 @@ fn test_query_matches_with_many_overlapp
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_capturing_error_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -742,6 +755,7 @@ fn test_query_matches_capturing_error_no
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_extra_children() {
     allocations::record(|| {
         let language = get_language("ruby");
@@ -786,6 +800,7 @@ fn test_query_matches_with_extra_childre
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_named_wildcard() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -819,6 +834,7 @@ fn test_query_matches_with_named_wildcar
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_wildcard_at_the_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -867,6 +883,7 @@ fn test_query_matches_with_wildcard_at_t
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_immediate_siblings() {
     allocations::record(|| {
         let language = get_language("python");
@@ -947,6 +964,7 @@ fn test_query_matches_with_immediate_sib
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_last_named_child() {
     allocations::record(|| {
         let language = get_language("c");
@@ -974,6 +992,7 @@ fn test_query_matches_with_last_named_ch
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_negated_fields() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1040,6 +1059,7 @@ fn test_query_matches_with_negated_field
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_field_at_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1059,6 +1079,7 @@ fn test_query_matches_with_field_at_root
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_repeated_leaf_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1123,6 +1144,7 @@ fn test_query_matches_with_repeated_leaf
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_optional_nodes_inside_of_repetitions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1144,6 +1166,7 @@ fn test_query_matches_with_optional_node
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_top_level_repetitions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1177,6 +1200,7 @@ fn test_query_matches_with_top_level_rep
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_non_terminal_repetitions_within_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1197,6 +1221,7 @@ fn test_query_matches_with_non_terminal_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_nested_repetitions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1232,6 +1257,7 @@ fn test_query_matches_with_nested_repeti
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_multiple_repetition_patterns_that_intersect_other_pattern() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1282,6 +1308,7 @@ fn test_query_matches_with_multiple_repe
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_trailing_repetitions_of_last_child() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1311,6 +1338,7 @@ fn test_query_matches_with_trailing_repe
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_leading_zero_or_more_repeated_leaf_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1365,6 +1393,7 @@ fn test_query_matches_with_leading_zero_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_trailing_optional_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1401,6 +1430,7 @@ fn test_query_matches_with_trailing_opti
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_nested_optional_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1444,6 +1474,7 @@ fn test_query_matches_with_nested_option
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_repeated_internal_nodes() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1475,6 +1506,7 @@ fn test_query_matches_with_repeated_inte
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_simple_alternatives() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1515,6 +1547,7 @@ fn test_query_matches_with_simple_altern
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_alternatives_in_repetitions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1552,6 +1585,7 @@ fn test_query_matches_with_alternatives_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_alternatives_at_root() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1594,6 +1628,7 @@ fn test_query_matches_with_alternatives_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_alternatives_under_fields() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1630,6 +1665,7 @@ fn test_query_matches_with_alternatives_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_in_language_with_simple_aliases() {
     allocations::record(|| {
         let language = get_language("html");
@@ -1662,6 +1698,7 @@ fn test_query_matches_in_language_with_s
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_different_tokens_with_the_same_string_value() {
     allocations::record(|| {
         // In Rust, there are two '<' tokens: one for the binary operator,
@@ -1692,6 +1729,7 @@ fn test_query_matches_with_different_tok
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_too_many_permutations_to_track() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1727,6 +1765,7 @@ fn test_query_matches_with_too_many_perm
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_sibling_patterns_dont_match_children_of_an_error() {
     allocations::record(|| {
         let language = get_language("rust");
@@ -1788,6 +1827,7 @@ fn test_query_sibling_patterns_dont_matc
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_alternatives_and_too_many_permutations_to_track() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1828,6 +1868,7 @@ fn test_query_matches_with_alternatives_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_anonymous_tokens() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1857,6 +1898,7 @@ fn test_query_matches_with_anonymous_tok
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_supertypes() {
     allocations::record(|| {
         let language = get_language("python");
@@ -1900,6 +1942,7 @@ fn test_query_matches_with_supertypes()
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_within_byte_range() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -1959,6 +2002,7 @@ fn test_query_matches_within_byte_range(
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_within_point_range() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2015,6 +2059,7 @@ fn test_query_matches_within_point_range
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_within_byte_range() {
     allocations::record(|| {
         let language = get_language("c");
@@ -2055,6 +2100,7 @@ fn test_query_captures_within_byte_range
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_unrooted_patterns_intersecting_byte_range() {
     allocations::record(|| {
         let language = get_language("rust");
@@ -2110,6 +2156,7 @@ fn test_query_matches_with_unrooted_patt
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_wildcard_at_root_intersecting_byte_range() {
     allocations::record(|| {
         let language = get_language("python");
@@ -2173,6 +2220,7 @@ fn test_query_matches_with_wildcard_at_r
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_within_byte_range_assigned_after_iterating() {
     allocations::record(|| {
         let language = get_language("rust");
@@ -2260,6 +2308,7 @@ fn test_query_captures_within_byte_range
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_different_queries_same_cursor() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2322,6 +2371,7 @@ fn test_query_matches_different_queries_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_multiple_captures_on_a_node() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2376,6 +2426,7 @@ fn test_query_matches_with_multiple_capt
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_captured_wildcard_at_root() {
     allocations::record(|| {
         let language = get_language("python");
@@ -2464,6 +2515,7 @@ fn test_query_matches_with_captured_wild
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_no_captures() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2495,6 +2547,7 @@ fn test_query_matches_with_no_captures()
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_repeated_fields() {
     allocations::record(|| {
         let language = get_language("c");
@@ -2523,6 +2576,7 @@ fn test_query_matches_with_repeated_fiel
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_deeply_nested_patterns_with_fields() {
     allocations::record(|| {
         let language = get_language("python");
@@ -2612,6 +2666,7 @@ fn test_query_matches_with_deeply_nested
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_matches_with_indefinite_step_containing_no_captures() {
     allocations::record(|| {
         // This pattern depends on the field declarations within the
@@ -2663,6 +2718,7 @@ fn test_query_matches_with_indefinite_st
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_basic() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2739,6 +2795,7 @@ fn test_query_captures_basic() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_text_conditions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2795,6 +2852,7 @@ fn test_query_captures_with_text_conditi
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_predicates() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2844,6 +2902,7 @@ fn test_query_captures_with_predicates()
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_quoted_predicate_args() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2892,6 +2951,7 @@ fn test_query_captures_with_quoted_predi
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_duplicates() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2926,6 +2986,7 @@ fn test_query_captures_with_duplicates()
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_many_nested_results_without_fields() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -2990,6 +3051,7 @@ fn test_query_captures_with_many_nested_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_many_nested_results_with_fields() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3058,6 +3120,7 @@ fn test_query_captures_with_many_nested_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_too_many_nested_results() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3151,6 +3214,7 @@ fn test_query_captures_with_too_many_nes
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_definite_pattern_containing_many_nested_matches() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3200,6 +3264,7 @@ fn test_query_captures_with_definite_pat
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_ordered_by_both_start_and_end_positions() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3241,6 +3306,7 @@ fn test_query_captures_ordered_by_both_s
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_matches_removed() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3281,6 +3347,7 @@ fn test_query_captures_with_matches_remo
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_with_matches_removed_before_they_finish() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3329,6 +3396,7 @@ fn test_query_captures_with_matches_remo
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_captures_and_matches_iterators_are_fused() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3373,6 +3441,7 @@ fn test_query_captures_and_matches_itera
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_text_callback_returns_chunks() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3489,6 +3558,7 @@ fn test_query_start_byte_for_pattern() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_capture_names() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3522,6 +3592,7 @@ fn test_query_capture_names() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_lifetime_is_separate_from_nodes_lifetime() {
     allocations::record(|| {
         let query = r#"(call_expression) @call"#;
@@ -3579,6 +3650,7 @@ fn test_query_lifetime_is_separate_from_
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_with_no_patterns() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3590,6 +3662,7 @@ fn test_query_with_no_patterns() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_comments() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3620,6 +3693,7 @@ fn test_query_comments() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_disable_pattern() {
     allocations::record(|| {
         let language = get_language("javascript");
@@ -3660,6 +3734,7 @@ fn test_query_disable_pattern() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_alternative_predicate_prefix() {
     allocations::record(|| {
         let language = get_language("c");
@@ -3694,6 +3769,7 @@ fn test_query_alternative_predicate_pref
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_random() {
     use pretty_assertions::assert_eq;
 
@@ -3754,6 +3830,7 @@ fn test_query_random() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_is_pattern_guaranteed_at_step() {
     struct Row {
         language: Language,
@@ -4059,6 +4136,7 @@ fn test_query_is_pattern_guaranteed_at_s
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_query_is_pattern_rooted() {
     struct Row {
         description: &'static str,
@@ -4151,6 +4229,7 @@ fn test_query_is_pattern_rooted() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_capture_quantifiers() {
     struct Row {
         description: &'static str,
--- rust-tree-sitter-cli-0.20.7.orig/src/tests/tags_test.rs
+++ rust-tree-sitter-cli-0.20.7/src/tests/tags_test.rs
@@ -264,6 +264,7 @@ fn test_tags_ruby() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_tags_cancellation() {
     use std::sync::atomic::{AtomicUsize, Ordering};
 
@@ -339,6 +340,7 @@ fn test_tags_with_parse_error() {
 
 #[test]
 #[ignore="Fixtures aren't in the crate"]
+#[cfg(target_has_atomic = "64")]
 fn test_tags_via_c_api() {
     allocations::record(|| {
         let tagger = c::ts_tagger_new();
