From 4e2a70f186560292bb73e030b67d54bf6faf1a9f Mon Sep 17 00:00:00 2001
From: akern40 <akern40@gmail.com>
Date: Sun, 30 Mar 2025 00:35:18 -0400
Subject: [PATCH] Allows benchmarks that do not use linspace to run on no_std
 (#1495)

---
 benches/bench1.rs         | 5 +++++
 benches/construct.rs      | 2 ++
 benches/higher-order.rs   | 5 +++++
 benches/iter.rs           | 6 ++++++
 benches/numeric.rs        | 1 +
 src/linalg/impl_linalg.rs | 1 -
 6 files changed, 19 insertions(+), 1 deletion(-)

--- a/benches/bench1.rs
+++ b/benches/bench1.rs
@@ -982,6 +982,7 @@
 
 const MEAN_SUM_N: usize = 127;
 
+#[cfg(feature = "std")]
 fn range_mat(m: Ix, n: Ix) -> Array2<f32>
 {
     assert!(m * n != 0);
@@ -990,6 +991,7 @@
         .unwrap()
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn mean_axis0(bench: &mut test::Bencher)
 {
@@ -997,6 +999,7 @@
     bench.iter(|| a.mean_axis(Axis(0)));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn mean_axis1(bench: &mut test::Bencher)
 {
@@ -1004,6 +1007,7 @@
     bench.iter(|| a.mean_axis(Axis(1)));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn sum_axis0(bench: &mut test::Bencher)
 {
@@ -1011,6 +1015,7 @@
     bench.iter(|| a.sum_axis(Axis(0)));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn sum_axis1(bench: &mut test::Bencher)
 {
--- a/benches/construct.rs
+++ b/benches/construct.rs
@@ -19,6 +19,7 @@
     bench.iter(|| Array::<f64, _>::zeros((128, 128)))
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_regular(bench: &mut test::Bencher)
 {
@@ -28,6 +29,7 @@
     bench.iter(|| a.map(|&x| 2. * x));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_stride(bench: &mut test::Bencher)
 {
--- a/benches/higher-order.rs
+++ b/benches/higher-order.rs
@@ -12,6 +12,7 @@
 const X: usize = 64;
 const Y: usize = 16;
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_regular(bench: &mut Bencher)
 {
@@ -26,6 +27,7 @@
     a *= 2.0;
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_stride_double_f64(bench: &mut Bencher)
 {
@@ -38,6 +40,7 @@
     });
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_stride_f64(bench: &mut Bencher)
 {
@@ -48,6 +51,7 @@
     bench.iter(|| av.map(|&x| 2. * x));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn map_stride_u32(bench: &mut Bencher)
 {
@@ -59,6 +63,7 @@
     bench.iter(|| av.map(|&x| 2 * x));
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn fold_axis(bench: &mut Bencher)
 {
--- a/benches/iter.rs
+++ b/benches/iter.rs
@@ -45,6 +45,7 @@
     bench.iter(|| a.iter().sum::<i32>());
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_filter_sum_2d_u32(bench: &mut Bencher)
 {
@@ -55,6 +56,7 @@
     bench.iter(|| b.iter().filter(|&&x| x < 75).sum::<u32>());
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_filter_sum_2d_f32(bench: &mut Bencher)
 {
@@ -65,6 +67,7 @@
     bench.iter(|| b.iter().filter(|&&x| x < 75.).sum::<f32>());
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_filter_sum_2d_stride_u32(bench: &mut Bencher)
 {
@@ -76,6 +79,7 @@
     bench.iter(|| b.iter().filter(|&&x| x < 75).sum::<u32>());
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_filter_sum_2d_stride_f32(bench: &mut Bencher)
 {
@@ -87,6 +91,7 @@
     bench.iter(|| b.iter().filter(|&&x| x < 75.).sum::<f32>());
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_rev_step_by_contiguous(bench: &mut Bencher)
 {
@@ -98,6 +103,7 @@
     });
 }
 
+#[cfg(feature = "std")]
 #[bench]
 fn iter_rev_step_by_discontiguous(bench: &mut Bencher)
 {
--- a/benches/numeric.rs
+++ b/benches/numeric.rs
@@ -9,6 +9,7 @@
 const X: usize = 64;
 const Y: usize = 16;
 
+#[cfg(feature = "std")]
 #[bench]
 fn clip(bench: &mut Bencher)
 {
--- a/src/linalg/impl_linalg.rs
+++ b/src/linalg/impl_linalg.rs
@@ -1057,7 +1057,6 @@
 
         for stride in 1..=MAXSTRIDE {
             let m = ArrayView::from_shape((N, N).strides((stride, 1)), &data).unwrap();
-            eprintln!("{:?}", m);
 
             if stride < N {
                 assert_eq!(get_blas_compatible_layout(&m), None);
