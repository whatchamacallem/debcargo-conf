From b7f2f3be3c6c2cda767d619b3faf4bd7abe955fc Mon Sep 17 00:00:00 2001
From: Widagdo Setiawan <widagdos@gmail.com>
Date: Thu, 25 Apr 2024 04:10:35 -0700
Subject: [PATCH 14/46] Update rust toolchain to 1.70.0 (#874)

---
 .github/workflows/rust.yml                       |  2 +-
 Cargo.toml                                       |  2 +-
 README.md                                        |  2 +-
 librocksdb-sys/Cargo.toml                        |  2 +-
 src/prop_name.rs                                 |  5 +----
 tests/fail/checkpoint_outlive_db.stderr          |  1 +
 tests/fail/iterator_outlive_db.stderr            |  1 +
 ..._with_multiple_refs_as_single_threaded.stderr | 16 ++++++++++------
 tests/fail/snapshot_outlive_db.stderr            |  1 +
 tests/fail/snapshot_outlive_transaction.stderr   |  1 +
 .../fail/snapshot_outlive_transaction_db.stderr  |  1 +
 .../transaction_outlive_transaction_db.stderr    |  1 +
 12 files changed, 21 insertions(+), 14 deletions(-)

--- rocksdb.orig/.github/workflows/rust.yml
+++ rocksdb/.github/workflows/rust.yml
@@ -2,7 +2,7 @@
 
 on: [push, pull_request]
 env:
-  RUST_VERSION: 1.66.0
+  RUST_VERSION: 1.70.0
 
 jobs:
   fmt:
--- rocksdb.orig/Cargo.toml
+++ rocksdb/Cargo.toml
@@ -11,7 +11,7 @@
 
 [package]
 edition = "2018"
-rust-version = "1.66.0"
+rust-version = "1.70.0"
 name = "rocksdb"
 version = "0.22.0"
 authors = [
--- rocksdb.orig/src/prop_name.rs
+++ rocksdb/src/prop_name.rs
@@ -17,12 +17,9 @@
     /// Panics if the `value` isnâ€™t terminated by a nul byte or contains
     /// interior nul bytes.
     pub(crate) const fn new_unwrap(value: &str) -> &Self {
-        let bytes = if let Some((&0, bytes)) = value.as_bytes().split_last() {
-            bytes
-        } else {
+        let Some((&0, bytes)) = value.as_bytes().split_last() else {
             panic!("input was not nul-terminated");
         };
-
         let mut idx = 0;
         while idx < bytes.len() {
             assert!(bytes[idx] != 0, "input contained interior nul byte");
--- rocksdb.orig/tests/fail/checkpoint_outlive_db.stderr
+++ rocksdb/tests/fail/checkpoint_outlive_db.stderr
@@ -4,6 +4,7 @@
 4 |     let _checkpoint = {
   |         ----------- borrow later stored here
 5 |         let db = DB::open_default("foo").unwrap();
+  |             -- binding `db` declared here
 6 |         Checkpoint::new(&db)
   |                         ^^^ borrowed value does not live long enough
 7 |     };
--- rocksdb.orig/tests/fail/iterator_outlive_db.stderr
+++ rocksdb/tests/fail/iterator_outlive_db.stderr
@@ -4,6 +4,7 @@
 4 |     let _iter = {
   |         ----- borrow later stored here
 5 |         let db = DB::open_default("foo").unwrap();
+  |             -- binding `db` declared here
 6 |         db.iterator(IteratorMode::Start)
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ borrowed value does not live long enough
 7 |     };
--- rocksdb.orig/tests/fail/open_with_multiple_refs_as_single_threaded.stderr
+++ rocksdb/tests/fail/open_with_multiple_refs_as_single_threaded.stderr
@@ -1,17 +1,21 @@
 error[E0596]: cannot borrow `*db_ref1` as mutable, as it is behind a `&` reference
  --> tests/fail/open_with_multiple_refs_as_single_threaded.rs:8:5
   |
-5 |     let db_ref1 = &db;
-  |                   --- help: consider changing this to be a mutable reference: `&mut db`
-...
 8 |     db_ref1.create_cf("cf1", &opts).unwrap();
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `db_ref1` is a `&` reference, so the data it refers to cannot be borrowed as mutable
+  |
+help: consider changing this to be a mutable reference
+  |
+5 |     let db_ref1 = &mut db;
+  |                   ~~~~~~~
 
 error[E0596]: cannot borrow `*db_ref2` as mutable, as it is behind a `&` reference
  --> tests/fail/open_with_multiple_refs_as_single_threaded.rs:9:5
   |
-6 |     let db_ref2 = &db;
-  |                   --- help: consider changing this to be a mutable reference: `&mut db`
-...
 9 |     db_ref2.create_cf("cf2", &opts).unwrap();
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `db_ref2` is a `&` reference, so the data it refers to cannot be borrowed as mutable
+  |
+help: consider changing this to be a mutable reference
+  |
+6 |     let db_ref2 = &mut db;
+  |                   ~~~~~~~
--- rocksdb.orig/tests/fail/snapshot_outlive_db.stderr
+++ rocksdb/tests/fail/snapshot_outlive_db.stderr
@@ -4,6 +4,7 @@
 4 |     let _snapshot = {
   |         --------- borrow later stored here
 5 |         let db = DB::open_default("foo").unwrap();
+  |             -- binding `db` declared here
 6 |         db.snapshot()
   |         ^^^^^^^^^^^^^ borrowed value does not live long enough
 7 |     };
--- rocksdb.orig/tests/fail/snapshot_outlive_transaction.stderr
+++ rocksdb/tests/fail/snapshot_outlive_transaction.stderr
@@ -4,6 +4,7 @@
 5 |     let _snapshot = {
   |         --------- borrow later stored here
 6 |         let txn = db.transaction();
+  |             --- binding `txn` declared here
 7 |         txn.snapshot()
   |         ^^^^^^^^^^^^^^ borrowed value does not live long enough
 8 |     };
--- rocksdb.orig/tests/fail/snapshot_outlive_transaction_db.stderr
+++ rocksdb/tests/fail/snapshot_outlive_transaction_db.stderr
@@ -4,6 +4,7 @@
 4 |     let _snapshot = {
   |         --------- borrow later stored here
 5 |         let db = TransactionDB::<SingleThreaded>::open_default("foo").unwrap();
+  |             -- binding `db` declared here
 6 |         db.snapshot()
   |         ^^^^^^^^^^^^^ borrowed value does not live long enough
 7 |     };
--- rocksdb.orig/tests/fail/transaction_outlive_transaction_db.stderr
+++ rocksdb/tests/fail/transaction_outlive_transaction_db.stderr
@@ -4,6 +4,7 @@
 4 |     let _txn = {
   |         ---- borrow later stored here
 5 |         let db = TransactionDB::<SingleThreaded>::open_default("foo").unwrap();
+  |             -- binding `db` declared here
 6 |         db.transaction()
   |         ^^^^^^^^^^^^^^^^ borrowed value does not live long enough
 7 |     };
